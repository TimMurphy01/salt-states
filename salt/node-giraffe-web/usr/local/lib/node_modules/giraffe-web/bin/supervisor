#!/usr/bin/env bash

{% from 'npm/map.jinja' import map with context -%}
{% set dir     = map.get('/usr/local/lib/node_modules', {}).get('file', {}).get('name') -%}
{% set minions = salt['roles.dict']('graphite-web', out='nodename') -%}
{% set minion  = minions['graphite-web'][0]|default('localhost') -%}
{% set ip      = salt['dig.A'](minion)[0]|default(salt['hosts.get_ip'](minion))|default(minion, True) -%}

if !    ps -ef                                                                 \
   | egrep -q '[.]/bin/giraffe-web'                                            \
&&   [[ "{{ ip }}"                ]]                                           \
&& ! [[ "{{ ip }}" == "127.0.0.1" ]]
then
    cd    {{ dir }}/giraffe-web
    nohup {{ dir }}/supervisor/lib/cli-wrapper.js --                           \
              ./bin/giraffe-web -c dashboards.js                               \
                  --graphite-url=http://{{ ip }} &>/dev/null &
fi
