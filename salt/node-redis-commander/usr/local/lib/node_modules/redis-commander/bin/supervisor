#!/usr/bin/env bash

{% from  'npm/map.jinja'
   import npm
   with   context -%}
{% set dir     = npm['/usr/local/lib/node_modules']['file']['name'] -%}
{% set minions = salt['roles.dict']('redis-server', out='nodename') -%}
{% set minion  = minions['redis-server'][0]|default('localhost') -%}
{% set ip      = salt['dig.A'](minion)[0]|default(salt['hosts.get_ip'](minion))|default(minion, True) -%}

if !    ps -ef                                                                 \
   | egrep -q '[r]edis-commander'                                              \
&& [[ "{{ ip }}" ]]
then
    find         ~/.redis-commander -empty -exec rm -f {} \;
    cd    {{ dir }}/redis-commander
    nohup {{ dir }}/supervisor/lib/cli-wrapper.js --                           \
              ./bin/redis-commander.js --redis-host {{ ip }} &>/dev/null &
fi
